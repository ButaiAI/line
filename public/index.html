<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡èœé›†è·ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ­ã‚°ã‚¤ãƒ³</title>
    <link rel="stylesheet" href="./css/style.css">
    <meta name="description" content="é‡èœé›†è·ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - è¾²å®¶ã®çš†æ§˜ã®é›†è·ç”³è«‹ã‚’ç°¡å˜ã«ç®¡ç†">
    <meta name="theme-color" content="#4CAF50">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥¬</text></svg>">
</head>
<body>
    <div class="container">
        <div class="login-card fade-in">
            <div class="logo">
                <h1><span class="logo-icon">ğŸ¥¬</span>é‡èœé›†è·ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <p>è¾²å®¶ã®çš†æ§˜ã®é›†è·ç”³è«‹ã‚’ç°¡å˜ã«ç®¡ç†</p>
            </div>
            
            <div class="login-methods">
                <!-- LINE ãƒ­ã‚°ã‚¤ãƒ³ -->
                <div class="line-login">
                    <button id="lineLoginBtn" class="btn btn-line btn-full" type="button">
                        <span>ğŸŸ¢</span>
                        <span>LINEã§ãƒ­ã‚°ã‚¤ãƒ³</span>
                    </button>
                    <p class="text-muted text-center" style="margin-top: 12px; font-size: 0.9rem;">
                        LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å®‰å…¨ã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™
                    </p>
                </div>
                
                <!-- é–‹ç™ºè€…ç”¨ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³ -->
                <div class="test-login" id="testLoginSection">
                    <h3>é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ãƒ­ã‚°ã‚¤ãƒ³</h3>
                    <form id="testLoginForm">
                        <div class="form-group">
                            <label for="testLineId" class="form-label">LINE IDï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰:</label>
                            <input 
                                type="text" 
                                id="testLineId" 
                                name="testLineId" 
                                class="form-input"
                                placeholder="Uxxxxxxxxxxxxxxxxxxxx" 
                                value="U12345678901234567890"
                                required
                            >
                            <small class="form-help">é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®LINE User IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                        </div>
                        <div class="form-group">
                            <label for="testUserName" class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                            <input 
                                type="text" 
                                id="testUserName" 
                                name="testUserName" 
                                class="form-input"
                                placeholder="ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼" 
                                value="ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼"
                                required
                            >
                            <small class="form-help">è¡¨ç¤ºç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                        </div>
                        <button type="submit" class="btn btn-secondary btn-full" id="testLoginSubmitBtn">
                            <span class="loading d-none">
                                <span class="loading-spinner"></span>
                                <span>ãƒ­ã‚°ã‚¤ãƒ³ä¸­...</span>
                            </span>
                            <span class="btn-text">ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³</span>
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div id="messageArea" class="message-area d-none"></div>
            
            <!-- ä½¿ç”¨æ–¹æ³• -->
            <div class="usage-info" style="margin-top: 30px; text-align: left;">
                <h4 style="color: #4CAF50; margin-bottom: 15px;">ğŸ“± ä½¿ç”¨æ–¹æ³•</h4>
                <ul style="color: #666; font-size: 0.9rem; line-height: 1.6; padding-left: 20px;">
                    <li><strong>LINEèªè¨¼:</strong> LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å®‰å…¨ã«ãƒ­ã‚°ã‚¤ãƒ³</li>
                    <li><strong>é›†è·ç”³è«‹:</strong> é‡èœã®é›†è·ç”³è«‹ã‚’ç°¡å˜ã«ç™»éŒ²</li>
                    <li><strong>å±¥æ­´ç¢ºèª:</strong> éå»ã®ç”³è«‹çŠ¶æ³ã‚’ä¸€è¦§ã§ç¢ºèª</li>
                    <li><strong>ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ:</strong> ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã‚‚å¿«é©ã«åˆ©ç”¨</li>
                </ul>
            </div>
            
            <!-- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± -->
            <div class="system-info text-center" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <p class="text-muted" style="font-size: 0.8rem;">
                    é‡èœé›†è·ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0<br>
                    <span id="systemStatus" class="text-success">ğŸŸ¢ ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ç¨¼åƒä¸­</span>
                </p>
            </div>
        </div>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading">
            <div class="loading-spinner"></div>
            <span>å‡¦ç†ä¸­...</span>
        </div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
        const APP_CONFIG = {
            apiBaseUrl: window.location.origin,
            lineChannelId: '2006505297', // å®Ÿéš›ã®LINE Channel IDã«ç½®ãæ›ãˆã‚‹
            redirectUri: window.location.origin + '/callback.html',
            isDevelopment: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        };

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.textContent = message;
            messageArea.className = `message-area ${type}`;
            messageArea.classList.remove('d-none');
            
            // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
            setTimeout(() => {
                messageArea.classList.add('d-none');
            }, 5000);
        }

        function hideMessage() {
            const messageArea = document.getElementById('messageArea');
            messageArea.classList.add('d-none');
        }

        // LINEèªè¨¼URLç”Ÿæˆ
        function generateLineLoginUrl() {
            const state = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('lineLoginState', state);
            
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: APP_CONFIG.lineChannelId,
                redirect_uri: APP_CONFIG.redirectUri,
                state: state,
                scope: 'profile openid'
            });
            
            return 'https://access.line.me/oauth2/v2.1/authorize?' + params.toString();
        }

        // æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        async function testLogin(lineId, userName) {
            showLoading(true);
            hideMessage();
            
            try {
                console.log('ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹:', { lineId, userName });
                
                const response = await fetch(`${APP_CONFIG.apiBaseUrl}/api/auth/test-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lineId: lineId.trim(),
                        userName: userName.trim()
                    })
                });

                const result = await response.json();
                console.log('ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³çµæœ:', result);

                if (result.success && result.token) {
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    
                    showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒ¡ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = '/main.html';
                    }, 1500);
                } else {
                    throw new Error(result.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showMessage(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        async function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            if (!token) return false;
            
            try {
                const response = await fetch(`${APP_CONFIG.apiBaseUrl}/api/auth/verify`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return true;
                    }
                }
            } catch (error) {
                console.error('èªè¨¼ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            return false;
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${APP_CONFIG.apiBaseUrl}/api/health`, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                const statusElement = document.getElementById('systemStatus');
                if (response.ok) {
                    statusElement.innerHTML = 'ğŸŸ¢ ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ç¨¼åƒä¸­';
                    statusElement.className = 'text-success';
                } else {
                    throw new Error('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼');
                }
            } catch (error) {
                const statusElement = document.getElementById('systemStatus');
                statusElement.innerHTML = 'ğŸ”´ ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­';
                statusElement.className = 'text-danger';
                console.warn('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªå¤±æ•—:', error);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢åˆæœŸåŒ–é–‹å§‹');
            
            // é–‹ç™ºç’°å¢ƒã§ã®ã¿ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const testLoginSection = document.getElementById('testLoginSection');
            if (!APP_CONFIG.isDevelopment) {
                testLoginSection.style.display = 'none';
            }
            
            // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
            const isAuthenticated = await checkAuthStatus();
            if (isAuthenticated) {
                showMessage('æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã™ã€‚ãƒ¡ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™...', 'info');
                setTimeout(() => {
                    window.location.href = '/main.html';
                }, 1500);
                return;
            }
            
            // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
            await checkSystemStatus();
            
            // LINEãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
            document.getElementById('lineLoginBtn').addEventListener('click', function() {
                showMessage('LINEèªè¨¼ç”»é¢ã«ç§»å‹•ã—ã¾ã™...', 'info');
                const loginUrl = generateLineLoginUrl();
                window.location.href = loginUrl;
            });
            
            // ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('testLoginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('testLoginSubmitBtn');
                const loading = submitBtn.querySelector('.loading');
                const btnText = submitBtn.querySelector('.btn-text');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹å¤‰æ›´
                loading.classList.remove('d-none');
                btnText.classList.add('d-none');
                submitBtn.disabled = true;
                
                try {
                    const lineId = document.getElementById('testLineId').value;
                    const userName = document.getElementById('testUserName').value;
                    
                    if (!lineId || !userName) {
                        throw new Error('LINE IDã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    }
                    
                    await testLogin(lineId, userName);
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
                    loading.classList.add('d-none');
                    btnText.classList.remove('d-none');
                    submitBtn.disabled = false;
                }
            });
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                switch (error) {
                    case 'access_denied':
                        errorMessage = 'LINEèªè¨¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ';
                        break;
                    case 'invalid_request':
                        errorMessage = 'ç„¡åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™';
                        break;
                    case 'server_error':
                        errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                        break;
                    default:
                        errorMessage = decodeURIComponent(error);
                }
                showMessage(errorMessage, 'error');
            }
            
            console.log('ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢åˆæœŸåŒ–å®Œäº†');
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(e) {
            console.error('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', e.error);
            showMessage('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
        });

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('online', function() {
            showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå›å¾©ã—ã¾ã—ãŸ', 'success');
            checkSystemStatus();
        });

        window.addEventListener('offline', function() {
            showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'warning');
        });
    </script>
</body>
</html>